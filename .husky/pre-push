#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Check if GitHub CLI is installed
if ! command -v gh > /dev/null 2>&1; then
  echo "Error: GitHub CLI ('gh') is not installed."
  exit 1
fi

# Load the .env.gh file if it exists
if [ -f .env.gh ]; then
  export $(grep -v '^#' .env.gh | xargs)
else
  echo "Error: .env.gh file not found. Please create it and add your GITHUB_TOKEN."
  exit 1
fi

# Check if GITHUB_TOKEN is set
if [ -z "$GITHUB_TOKEN" ]; then
  echo "Error: GITHUB_TOKEN is not set in .env.gh"
  exit 1
fi

# Get the current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Check if the current branch is already tracking a remote branch
UPSTREAM_BRANCH=$(git rev-parse --abbrev-ref --symbolic-full-name "@{u}" 2>/dev/null)

if [ -z "$UPSTREAM_BRANCH" ]; then
  echo "Branch \"$CURRENT_BRANCH\" is not tracking a remote branch. Setting upstream..."
  git push --set-upstream origin "$CURRENT_BRANCH" --no-verify
  if [ $? -ne 0 ]; then
    echo "Failed to push branch \"$CURRENT_BRANCH\" to remote."
    exit 1
  fi
  echo "Branch \"$CURRENT_BRANCH\" pushed successfully with upstream set."
else
  echo "Branch \"$CURRENT_BRANCH\" is already tracking \"$UPSTREAM_BRANCH\". Pushing without --set-upstream..."
  git push --no-verify
fi

# Check if a pull request already exists for this branch
EXISTING_PR=$(gh pr list --head "$CURRENT_BRANCH" --json url --jq '.[0].url' 2>/dev/null)
if [ -n "$EXISTING_PR" ]; then
  echo "A pull request for branch \"$CURRENT_BRANCH\" already exists: $EXISTING_PR"
else
  # Create a new pull request
  PR_URL=$(gh pr create --base main --head "$CURRENT_BRANCH" --title "PR for $CURRENT_BRANCH" --body "Auto-created PR")
  if [ $? -eq 0 ]; then
    echo "Pull Request created: $PR_URL"
  else
    echo "Failed to create a Pull Request."
    exit 1
  fi
fi

# Allow the push to continue
exit 0